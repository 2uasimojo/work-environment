#!/bin/bash
#
# Applies the following annotation to a ClusterDeployment on the
# hive-stage cluster for testing purposes:
#
#   hive.openshift.io/syncset-pause="true"
#

function get-hive-cluster {
  CLOUD_PROVIDER=$(ocm get /api/clusters_mgmt/v1/clusters/$1 | jq --raw-output '.cloud_provider.id')

  case $CLOUD_PROVIDER
  in
    aws)
      JSON_QUERY=".aws_account_operator_config.server"
      ;;
    gcp)
      JSON_QUERY=".gcp_account_operator_config.server"
      ;;
    *)
      echo "Unknown cloud provider: $CLOUD_PROVIDER" > /dev/stderr
      exit 1
  esac

  ocm get /api/clusters_mgmt/v1/clusters/$1/provision_shard | \
    jq --raw-output $JSON_QUERY | \
    awk '{ if (match($0, /^https:\/\/api\.([-a-z0-9]+)\./, groups)) print groups[1] }'
}

OCM_CLUSTERID=${1:-$OCM_CLUSTERID}
if [[ -z "$OCM_CLUSTERID" ]]
then
  echo "Usage: $0 <ocm-clusterid> [hive-cluster-name]" > /dev/stderr
  exit 1
fi
HIVE_CLUSTER=${2:-$(get-hive-cluster $OCM_CLUSTERID)}

case $(hostname)
in
  bastion-nasa-*.ops.openshift.com)
    case $HIVE_CLUSTER
    in
      # Hive clusters hosted on OSDv3
      hive-integration|hive-production|hive-stage)
        OC="ssh root@${HIVE_CLUSTER}-master -o StrictHostKeyChecking=no oc"
        ;;
      *)
        OC="oc --config=$HOME/.config/sre/clusters/v4/$HIVE_CLUSTER"
        ;;
    esac

    SELECTOR=api.openshift.com/id=$OCM_CLUSTERID
    ANNOTATION=hive.openshift.io/syncset-pause="true"

    HIVE_NAMESPACE=$($OC get clusterdeployment --all-namespaces --selector $SELECTOR --output json | jq --raw-output '.items[0].metadata.namespace')
    if [[ -z "$HIVE_NAMESPACE" ]]
    then
      echo "ClusterDeployment $OCM_CLUSTERID not found on $HIVE_CLUSTER" > /dev/stderr
      exit 1
    fi

    $OC annotate clusterdeployment --namespace $HIVE_NAMESPACE --selector $SELECTOR --overwrite $ANNOTATION
    ;;
  *)
    # Defer to the bastion host, which can access production Hive clusters.
    ssh bastion-nasa-1.ops.openshift.com bin/$(basename $0) $OCM_CLUSTERID $HIVE_CLUSTER
    ;;
esac
