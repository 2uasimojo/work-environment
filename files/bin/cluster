#!/bin/bash

if [[ -n $1 ]]
then
  export CLUSTERID=$1
fi

if [[ -z "$CLUSTERID" ]]
then
  echo "Usage: source cluster <clusterid>" > /dev/stderr
else
  case "$CLUSTERID" in
    # Special handling for v3 test clusters.
    mbarnestest1|mbarnestest2)
      export AWS_PROFILE="opstest"
      export AWS_DEFAULT_REGION="us-east-2"
      ;;
    *)
      V3_CACHE_DIR="$HOME/.cache/sre/clusters/v3"
      V4_CACHE_DIR="$HOME/.cache/sre/clusters/v4"
      V4_CONFIG_DIR="$HOME/.config/sre/clusters/v4"
      if [[ -f "$V3_CACHE_DIR/$CLUSTERID" ]]
      then
          export AWS_PROFILE=$(oo_account $CLUSTERID)
          export AWS_DEFAULT_REGION=$(oo_sublocation $CLUSTERID)
      elif [[ -f "$V4_CACHE_DIR/$CLUSTERID" ]]
      then
          mkdir -p "$V4_CONFIG_DIR"
          export KUBECONFIG="$V4_CONFIG_DIR/$CLUSTERID"
          export AWS_DEFAULT_REGION=$(get-cluster-var $CLUSTERID region.id)
          unset AWS_PROFILE
          if [[ ! -f "$KUBECONFIG" ]]
          then
              ocm cluster login --username=$(whoami) $(get-cluster-var $CLUSTERID id)
          fi
      else
          echo "Unknown cluster '$CLUSTERID'" > /dev/stderr
          unset AWS_PROFILE
          unset AWS_DEFAULT_REGION
      fi
      ;;
  esac

  if [[ -n "$AWS_PROFILE" ]]
  then
    echo "         CLUSTERID : $CLUSTERID"
    echo "       AWS_PROFILE : $AWS_PROFILE"
    echo "AWS_DEFAULT_REGION : $AWS_DEFAULT_REGION"
  elif [[ -n "$KUBECONFIG" ]]
  then
    echo "    (v4) CLUSTERID : $CLUSTERID"
    echo "AWS_DEFAULT_REGION : $AWS_DEFAULT_REGION"
  fi
fi

if [[ -n "$TMUX" ]]
then
  tmux rename-window "$CLUSTERID"
fi
